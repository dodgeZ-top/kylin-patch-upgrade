# 银河麒麟系统补丁升级脚本说明

## 作者

DodgeZ

## 功能概览

一个用于银河麒麟系统的一键补丁升级脚本，自动检测并应用名称包含*CNNVD* 补丁包，支持生成本地 yum 仓库、备份与恢复原有 repo、记录升级日志，简化补丁更新流程。

该脚本用于银河麒麟系统的一键补丁升级，主要功能包括：

1. **自动检测补丁包**
   - 支持任意名称中包含 `CNNVD` 的补丁包（例如 `sp3-2403-x86-CNNVD.tar.gz`）。
   - 在当前目录自动列出可用补丁包，用户通过序号选择要升级的补丁。
2. **自动解压补丁包**
   - 将所选补丁包解压到当前目录下，与压缩包同名的目录中。
3. **生成本地 YUM 仓库**
   - 使用 `createrepo` 在解压目录中生成本地 yum 仓库。
   - 临时替换系统原有 repo，保证升级过程只使用本地补丁包。
4. **备份与恢复原有 YUM 仓库**
   - 升级前自动备份 `/etc/yum.repos.d/` 下的所有 repo 文件。
   - 升级完成后自动恢复原有 repo。
5. **自动升级系统**
   - 清理 yum 缓存并生成新的缓存。
   - 使用 `yum update -y` 执行升级。
   - 升级过程中出现错误会打印命令和行号，便于排查。
6. **输出已安装主要包版本**
   - 从补丁包中提取 rpm 包名，检查并显示已安装的版本。
   - 只显示已安装的主要包版本，避免输出未安装包。
7. **日志管理**
   - 日志存放在 `~/kylin_patch_logs/` 目录，文件名以 `kylin_patch_日期_时间.log` 命名。
   - 支持多次运行，不会污染当前目录。
8. **安全与错误处理**
   - `set -euo pipefail`：遇到错误立即退出，未初始化变量报错，管道错误捕获。
   - `trap` 捕获退出和错误信号，确保日志保留并打印出错命令及行号。

## 使用方法

1. 将补丁包上传到脚本所在目录，补丁包名称必须包含 `CNNVD`。

2. 执行脚本：

   ```
   chmod +x kylin_update.sh && ./kylin_update.sh
   ```

3. 根据提示输入要升级的补丁包序号。

4. 脚本自动完成解压、生成 repo、升级、恢复 repo、输出版本信息。

5. 升级日志保存在 `~/kylin_patch_logs/` 目录下。

6. 清理脚本与补丁包：

   ```
   rm -f kylin_update.sh && rm -rf *CNNVD*
   ```

   

